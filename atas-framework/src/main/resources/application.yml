spring:
  application:
    name: atas-framework
  
  # Profile activation can be set via SPRING_PROFILES_ACTIVE environment variable
  # or via -Dspring.profiles.active=profile-name
  # Default is 'dev' if not specified
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  
  # Default datasource configuration (profile-specific files override these)
  datasource:
    url: ${DB_URL:jdbc:postgresql://localhost:5432/atasdb}
    username: ${DB_USERNAME:atas}
    password: ${DB_PASSWORD:ataspass}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: ${HIKARI_MAX_POOL_SIZE:20}
      minimum-idle: ${HIKARI_MIN_IDLE:5}
      connection-timeout: ${HIKARI_CONNECTION_TIMEOUT:30000}
      max-lifetime: ${HIKARI_MAX_LIFETIME:1800000}
      idle-timeout: ${HIKARI_IDLE_TIMEOUT:600000}
      leak-detection-threshold: ${HIKARI_LEAK_DETECTION_THRESHOLD:120000}  # Increased to 2 minutes to reduce false positives
      register-mbeans: true  # Enable JMX monitoring for connection pool
  
  # JPA/Hibernate configuration
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.PostgreSQLDialect
        use_sql_comments: true  # Add comments to SQL queries
  
  # Flyway database migration configuration
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true
    baseline-version: 0

  # Redis configuration for caching and Pub/Sub
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: ${REDIS_TIMEOUT:2000ms}
      lettuce:
        pool:
          max-active: ${REDIS_POOL_MAX_ACTIVE:8}
          max-idle: ${REDIS_POOL_MAX_IDLE:8}
          min-idle: ${REDIS_POOL_MIN_IDLE:0}
  
  # Cache configuration
  cache:
    type: redis
    redis:
      time-to-live: ${CACHE_TTL:60s}
      cache-null-values: false
      key-prefix: "atas:cache:"
    cache-names:
      - dashboard-overview
      - dashboard-recent
      - dashboard-trends
      - execution-status

# Custom ATAS configuration with environment variable support
atas:
  # Test discovery configuration
  test:
    base:
      path: ${ATAS_TEST_BASE_PATH:atas-tests/src/test/java/com/atas}
    environment: ${ATAS_TEST_ENVIRONMENT:${SPRING_PROFILES_ACTIVE:dev}}
    timeout:
      minutes: ${ATAS_TEST_TIMEOUT_MINUTES:30}
  # Maven wrapper configuration
  mvnw:
    path: ${ATAS_MVNW_PATH:/app/mvnw}
  # Playwright video configuration
  playwright:
    video:
      dir: ${PLAYWRIGHT_VIDEO_DIR:videos}
  # Storage configuration (profile-specific files provide defaults)
  storage:
    bucket: ${S3_BUCKET:atas-videos}
    region: ${S3_REGION:us-east-1}
    video-folder: ${S3_VIDEO_FOLDER:videos}
    screenshot-folder: ${S3_SCREENSHOT_FOLDER:screenshots}
  # Execution thread pool configuration
  execution:
    core-pool-size: ${ATAS_EXECUTION_CORE_POOL_SIZE:5}
    max-pool-size: ${ATAS_EXECUTION_MAX_POOL_SIZE:20}
    queue-capacity: ${ATAS_EXECUTION_QUEUE_CAPACITY:100}
    keep-alive-seconds: ${ATAS_EXECUTION_KEEP_ALIVE_SECONDS:60}
    output-capture-pool-size: ${ATAS_OUTPUT_CAPTURE_POOL_SIZE:50}
  # Security configuration
  security:
    jwt:
      secret: ${ATAS_JWT_SECRET:your-256-bit-secret-key-change-this-in-production-minimum-32-characters}
      expiration: ${ATAS_JWT_EXPIRATION_MS:86400000} # 24 hours
      refresh-expiration: ${ATAS_JWT_REFRESH_EXPIRATION_MS:604800000} # 7 days
    internal-api:
      secret: ${ATAS_INTERNAL_API_SECRET:internal-api-secret-key-change-this-in-production-minimum-32-characters-long}
      expiration: ${ATAS_INTERNAL_API_EXPIRATION_MS:3600000} # 1 hour
      api-key: ${ATAS_INTERNAL_API_KEY:internal-api-key-change-this-in-production}
    account:
      max-failed-attempts: ${ATAS_MAX_FAILED_ATTEMPTS:5}
      lockout-duration-minutes: ${ATAS_LOCKOUT_DURATION_MINUTES:30}

# Server configuration
server:
  port: ${SERVER_PORT:8080}
  tomcat:
    connection-timeout: ${SERVER_TOMCAT_CONNECTION_TIMEOUT:60000}  # 60 seconds
    threads:
      max: ${SERVER_TOMCAT_THREADS_MAX:200}
      min-spare: ${SERVER_TOMCAT_THREADS_MIN_SPARE:10}

# Management/Actuator endpoints
management:
  endpoints:
    web:
      exposure:
        include: "health,info"
  endpoint:
    health:
      show-details: when-authorized

# Default logging configuration
logging:
  level:
    root: INFO
    com.atas: INFO
    org.hibernate.SQL: WARN
    org.hibernate.type.descriptor.sql.BasicBinder: WARN
    org.springframework.jdbc.core: WARN

