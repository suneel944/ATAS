# Docker CI/CD Build and Push Fix

## Problem
The "Generate SBOM" step in the GitHub Actions workflow was failing with the error:
```
ERROR could not determine source: errors occurred attempting to resolve 'ghcr.io/sunee1944/atas:040618a613c27c20a223cf10c3b4004ef56460ae': manifest unknown
```

## Root Cause
The issue was a **tag mismatch** between the Docker image tags generated by the metadata action and the tag used in the SBOM generation step:

1. **Generated tags** (from metadata action):
   - `main` (for main branch)
   - `main-040618a613c27c20a223cf10c3b4004ef56460ae` (branch-SHA format)
   - `latest` (for default branch)

2. **SBOM step was looking for**:
   - `ghcr.io/sunee1944/atas:040618a613c27c20a223cf10c3b4004ef56460ae` (SHA only)

## Solution
Updated the `.github/workflows/build-and-push.yml` file with the following changes:

### 1. Fixed SBOM Image Tag
```yaml
# Before
image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

# After  
image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}-${{ github.sha }}
```

### 2. Added Image Pull Step
Added a step to pull the image locally before SBOM generation:
```yaml
- name: Pull image for SBOM generation
  run: |
    docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}-${{ github.sha }}
```

### 3. Added Debugging Steps
Added steps to help troubleshoot any future issues:
```yaml
- name: List available images
  run: |
    echo "Available image tags:"
    docker images | grep ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} || echo "No local images found"
    echo "Trying to pull image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}-${{ github.sha }}"

- name: Verify image exists
  run: |
    docker images | grep ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}-${{ github.sha }} || echo "Image not found locally"
```

### 4. Updated Notification Step
Fixed the notification step to use the correct tag format:
```yaml
# Before
echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

# After
echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}-${{ github.sha }}"
```

## Testing
Created a test script `scripts/test-docker-build.sh` to verify the Docker build process works locally:

```bash
./scripts/test-docker-build.sh
```

This script:
- Builds the Docker image
- Checks image size
- Tests container startup
- Tests health endpoint
- Tests SBOM generation (if syft is available)

## Expected Results
After this fix:
1. ✅ Docker image builds and pushes successfully
2. ✅ Image is available with the correct tag format
3. ✅ SBOM generation works without errors
4. ✅ All workflow steps complete successfully

## Tag Format Reference
The workflow now generates these tags:
- `ghcr.io/sunee1944/atas:main` (branch name)
- `ghcr.io/sunee1944/atas:main-<sha>` (branch-SHA format)
- `ghcr.io/sunee1944/atas:latest` (for default branch)

The SBOM generation uses the `branch-SHA` format which matches one of the generated tags.
